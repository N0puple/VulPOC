# Django核心SQL注入（CVE-2021-35042）

本文仅用于技术讨论与研究，文中的实现方法切勿应用在任何违法场景。如因涉嫌违法造成的一切不良影响，本文作者概不负责。

## 0x00 漏洞描述

`Django` 在2021年发布的安全更新，修复了在 `order_by ` 中存在的 `SQL` 注入漏洞。

## 0x01 漏洞影响

- Django 3.1.x < 3.1.13
- Django 3.2.x < 3.2.5

需要使用了 `order_by ` 

## 0x02 漏洞分析

出现问题的点是在 `order_by` ，先搜索这个方法

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220922105526.png)

首先 `clean_ordering` ，也就是将 `ordering` 置空

![](https://gitee.com/d5shenwu/picgo/raw/master/img/image-20220922105747504.png)

然后进行 `add_ordering`

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220922105840.png)

想要将传进来的字段添加到 `order_by` ，需要经过一些验证

将每一部分取出来进行比较，是字符串时进行比较，包含点号时，直接 `continue` ，跳过了后面的 `names_to_path` 验证，因此可以通过添加点号的形式绕过。

处理带点号的代码位于文件 `django/db/models/sql/compiler.py `的 `get_order_by `函数中，核心代码如下

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220922162157.png)

在这里对 `table` 进行了过滤，但是并没有对 `col` 进行过滤，因此造成了注入。

## 0x03 漏洞复现

复现直接借助了 `vulhub` 的环境，直接启动，环境代码可以直接在最下面的参考链接中找到

简单来个报错的 `payload`

```
http://127.0.0.1:8000/vuln/?order=aaa.tab'
```

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220922163320.png)

## 0x04 总结

总的来说这个漏洞算比较严重的，用到的场景相对来说会比较多。在看源码的过程中看了其他大佬写的文章，发现这个洞之前是存在过滤的，好像低版本就存在过滤，但是在之后为了解决某个问题而去掉了这个过滤，导致了漏洞的出现，所以有时候也能通过多看代码更改等来发现漏洞。

## 0x05 链接

目前在学代码审计，对此感兴趣的师傅可以加好友一起交流学习

环境与 `exp` 都可以在如下链接获取

### 参考链接

https://github.com/vulhub/vulhub/blob/master/django/CVE-2021-35042/README.zh-cn.md

### GitHub

https://github.com/d5shenwu/vulPOC

