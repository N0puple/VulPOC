# Django核心SQL注入（CVE-2022-28346）

本文仅用于技术讨论与研究，文中的实现方法切勿应用在任何违法场景。如因涉嫌违法造成的一切不良影响，本文作者概不负责。

## 0x00 漏洞描述

`Django` 在2022年发布的安全更新，修复了在 `QuerySet` 的 `annotate()`， `aggregate()`， `extra() `  等函数中存在的 `SQL` 注入漏洞。

## 0x01 漏洞影响

- Django 2.2.x < 2.2.28
- Django 3.2.x < 3.2.13
- Django 4.0.x < 4.0.4

需要使用了 `annotate`  或者 `aggregate` 或 `extra` 方法

## 0x02 漏洞分析

我们可以直接来到 `github` 修复记录

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923100805.png)

这里给 `add_annotation` 和 `add_extra` 两个函数中的参数添加了正则过滤，接下来我们就是要找到哪里使用到了这两个函数

这里其实可以通过测试用例来进行判断，我们可以看到修复记录中也存在测试用例的修复有点多，这里只选取一个进行分析

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923101337.png)

这里使用到了如下语句

```
Author.objects.aggregate(**{crafted_alias: Avg("age")})
```

`crafted_alias` 是用来测试的 `payload` ，我们先找到 `aggregate` 的实现位置

最终可以找到这里 `django\db\models\query.py`

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923101814.png)

传进来的 `args` 与 `kwargs`会经过 `_validate_values_are_expressions` 处理，但没有进行过滤

之后进过 `add_annotation` 进行赋值，如下

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923102244.png)

这里就是修复 `sql` 注入的位置，对 `alias` 进行了过滤，而目前这里没有进行过滤，直接成为了 `self.annotations` 的键，之后跟进会发现这个`self.annotations` 在 `resolve_ref` 函数中被取出来

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923103209.png)

这里会将我们之前的 `alias` 的值最终放到 `transform` 中，直接被使用

其他的漏洞函数与这个类似，就不分析了。

## 0x03 漏洞复现

复现环境参考之前的 `CVE-2020-7471` ，只需要更改 `views.py`

```
from django.shortcuts import render, HttpResponse
from .models import Collection
from django.contrib.postgres.aggregates.general import StringAgg
from django.db.models import Count

# Create your views here.

def vuln(request):
    query = request.GET.get('q')
    qs = Collection.objects.annotate(**{query:Count("name")})
    return HttpResponse(qs)

```

`payload` 如下

```
http://127.0.0.1:8000/vuln/?q=aaaaa%22
```

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923105043.png)

## 0x04 总结

分析了这几个漏洞之后，发现大部分的注入好像都发生在列名这一块儿，尤其是别名，尤其容易出现问题，之后可以着重多分析一下。

## 0x05 链接

目前在学代码审计，对此感兴趣的师傅可以加好友一起交流学习

环境与 `exp` 都可以在如下链接获取

### GitHub

https://github.com/N0puple/vulPOC

### 公众号

公众号搜索：安全漏洞复现

扫码持续关注：

![](https://gitee.com/N0puple/picgo/raw/master/img/qrcode_for_gh_a41358b842dd_430.jpg)

