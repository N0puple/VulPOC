# Django核心SQL注入（CVE-2022-28347）

本文仅用于技术讨论与研究，文中的实现方法切勿应用在任何违法场景。如因涉嫌违法造成的一切不良影响，本文作者概不负责。

## 0x00 漏洞描述

`Django` 在2022年发布的安全更新，修复了在 `QuerySet` 的 `explain()`函数中存在的 `SQL` 注入漏洞。

## 0x01 漏洞影响

- Django 2.2.x < 2.2.28
- Django 3.2.x < 3.2.13
- Django 4.0.x < 4.0.4

需要使用了 `explain`  方法，并且参数可控

## 0x02 漏洞分析

我们可以直接来到 `github` 修复记录

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923150326.png)

这里首先做的就是对 `options` 的内容进行过滤，如果包含敏感的字符，那么就报错，仅仅这些还没够，还做了如下更改

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923150512.png)

这里做了一个白名单，只有在这个白名单中的字符串才可以被使用，不会直接将所有的都拼接进去

有了修复的记录，我们就很容易定位到出现问题的地方，这里 `django\db\models\sql\compiler.py`  是将代码变成 `sql` 语句，在这里有一句关于 `explain` 的处理

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923150735.png)

`result` 是一个数组，里面的字符串最后都会拼接到一起，这里调用 `explain_query_prefix` 进行处理 `self.query.explain_options` 的内容，我们这里使用 `postgres` 数据库，并且 `postgres` 对这个函数存在重写，因此这里也直接看该数据库相关的处理

`django\db\backends\postgresql\operations.py`

 ![](https://gitee.com/N0puple/picgo/raw/master/img/20220923151019.png)

经过父类的处理后，在下面，会将`options` 中的每一个取出来，键直接为键，值存在就为 `true` ，因此值无法被更改，但是键会直接写入，最后拼接到 `prefix` 上去，因此这里的键存在注入。

## 0x03 漏洞复现

复现环境参考之前的 `CVE-2022-28346` ，只需要更改 `views.py`

```
from django.shortcuts import render, HttpResponse
from .models import Collection
from django.contrib.postgres.aggregates.general import StringAgg
from django.db.models import Count

import json
# Create your views here.

def vuln(request):
    query = request.GET.get('q')
    query = json.loads(query)
    qs = Collection.objects.filter(name="tom").explain(**query)
    return HttpResponse(qs)

```

`payload` 如下

```
http://127.0.0.1:8000/vuln/?q={%22ANALYZE%20true)%22:%22aaa%22}
```

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923151815.png)

## 0x04 总结

`explain` 相关的注入比较少见，好像 `mysql` 中也是存在这个函数的，按理说应该也可以使用该漏洞，不过目前没有去验证。

## 0x05 链接

目前在学代码审计，对此感兴趣的师傅可以加好友一起交流学习

环境与 `exp` 都可以在如下链接获取

### GitHub

https://github.com/N0puple/vulPOC

### 公众号

公众号搜索：安全漏洞复现

扫码持续关注：

![](https://gitee.com/N0puple/picgo/raw/master/img/qrcode_for_gh_a41358b842dd_430.jpg)

