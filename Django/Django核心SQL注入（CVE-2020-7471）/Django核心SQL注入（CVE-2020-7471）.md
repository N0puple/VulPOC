# Django核心SQL注入（CVE-2020-7471）

本文仅用于技术讨论与研究，文中的实现方法切勿应用在任何违法场景。如因涉嫌违法造成的一切不良影响，本文作者概不负责。

## 0x00 漏洞描述

`Django` 在2020年发布的一个安全更新，修复了在 `StringAgg` 中存在的SQL注入漏洞。

## 0x01 漏洞影响

- Django 2.2.x < 2.2.10
- Django 3.0.x < 3.0.3
- Django 1.11.x < 1.11.28

该漏洞需要开发者使用了 `StringAgg`  ，并且 `delimiter` 参数可控，则可以利用其进行攻击。

## 0x02 漏洞分析

先来看到 `github` 上的代码比对

![](https://gitee.com/N0puple/picgo/raw/master/img/20220921230809.png)

这里说明两点问题，第一， `delimter` 参数没有经过过滤就传入，第二，`delimter` 会直接进行字符串拼接，因此也是导致了存在 `SQL` 注入漏洞的原因。

接下来我们要做的就是找到使用该漏洞类的地方，关于 `StringAgg` 的使用可以看官方文档 `https://docs.djangoproject.com/zh-hans/4.1/ref/contrib/postgres/aggregates/` 

很容易就可以得到一个可以利用的场景

```
Collection.objects.annotate(tempname=StringAgg('name', delimiter=query)).values('name')
```

## 0x03 漏洞复现

`vulhub` 中没有找到相应的环境，找一个类似的环境改改，注意也需要使用 `postgres` 数据库

`views.py`

```
from django.shortcuts import render, HttpResponse
from .models import Collection
from django.contrib.postgres.aggregates.general import StringAgg

# Create your views here.

def vuln(request):
    query = request.GET.get('q', default=0.05)
    qs = Collection.objects.annotate(tempname=StringAgg('name', delimiter=query))
    print(qs.query)
    return HttpResponse(qs)

```

`models.py`

```
from django.db import models
from django.contrib.postgres.fields import JSONField


class Collection(models.Model):
    name = models.CharField(max_length=128)
    detail = models.CharField(max_length=128)

    def __str__(self):
        return self.name

```

`urls.py`

```
from django.contrib import admin
from django.urls import path
from vuln import views


urlpatterns = [
    path('admin/', admin.site.urls),
    path('vuln/', views.vuln),
]

```

最后可以得到如下 `poc`

![](https://gitee.com/N0puple/picgo/raw/master/img/20220921231943.png)

## 0x04 总结

这个洞较前几个洞来说比较直接，而且更容易理解。

## 0x05 链接

目前在学代码审计，对此感兴趣的师傅可以加好友一起交流学习

环境与 `exp` 都可以在如下链接获取

### GitHub

https://github.com/N0puple/vulPOC

### 公众号

公众号搜索：安全漏洞复现

扫码持续关注：

![](https://gitee.com/N0puple/picgo/raw/master/img/qrcode_for_gh_a41358b842dd_430.jpg)

