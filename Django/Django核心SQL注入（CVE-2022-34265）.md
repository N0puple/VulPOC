# Django核心SQL注入（CVE-2022-34265）

本文仅用于技术讨论与研究，文中的实现方法切勿应用在任何违法场景。如因涉嫌违法造成的一切不良影响，本文作者概不负责。

## 0x00 漏洞描述

`Django` 在2022年发布的安全更新，修复了在 `Trunc()` 和 `Extract()` 函数中存在的 `SQL` 注入漏洞。

## 0x01 漏洞影响

- Django 3.2.x < 3.2.14
- Django 4.0.x < 4.0.6

需要使用了 `Trunc()` 或 `Extract()`  方法，并且参数可控

## 0x02 漏洞分析

我们可以直接来到 `github` 修复记录

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923163054.png)

在这里是直接给 `Extract` 类或者 `Trunc` 类的 `as_sql` 方法添加了一层正则过滤。

这里我们以 `Extract` 为例，可以多关注被过滤的那个参数，也就是 `self.lookup_name` 

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923164046.png)

这里我们可以进入多个分支，但之后得处理实际上都差不多，我们先进入 `datetime_extract_sql` 

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923164231.png)

这里还是进入了和上面一样的 `date_extract_sql` 函数，而且没有经历其他的处理

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923164335.png)

看到 `lookup_type` ，就是我们之前传入的被过滤的参数，最后在 `else` 直接拼接了，直接造成 `sql` 注入。 

`trunc` 也是一样，不过进入的是 `datetime_trunc_sql`  或者 `time_trunc_sql` 等函数

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923164652.png)

## 0x03 漏洞复现

漏洞复现可以参照修复记录中的 `test` ，这里直接使用 `vulhub` 的环境，可以直接在下面获取

`payload`

```
http://127.0.0.1:8000/?date=aaa%27
```

![](https://gitee.com/N0puple/picgo/raw/master/img/20220923202021.png)

## 0x04 总结

这两函数我用得相对较少，但对于漏洞挖掘还是有借鉴意义的，这也是目前（20220923）最近的一个 `django` 注入，触发漏洞的形式与前面几个漏洞很像，说不定还有其他的地方也存在类似问题。

## 0x05 链接

目前在学代码审计，对此感兴趣的师傅可以加好友一起交流学习

环境与 `exp` 都可以在如下链接获取

### 参考链接

https://github.com/vulhub/vulhub/blob/master/django/CVE-2022-34265/README.zh-cn.md

### GitHub

https://github.com/N0puple/vulPOC



