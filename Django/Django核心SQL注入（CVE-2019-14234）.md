# Django核心SQL注入（CVE-2019-14234）

本文仅用于技术讨论与研究，文中的实现方法切勿应用在任何违法场景。如因涉嫌违法造成的一切不良影响，本文作者概不负责。

## 0x00 漏洞描述

`Django` 在2019年发布的一个安全更新，修复了在 `JSONField`、`HStoreField` 两个模型字段中存在的SQL注入漏洞。

## 0x01 漏洞影响

- Django 2.2.x < 2.2.4
- Django 2.1.x < 2.1.11
- Django 1.11.x < 1.11.23

该漏洞需要开发者使用了 `JSONField` 或者 `HStoreField` ，并且 `QuerySet` 中的键名可控，`Django` 自带的 `Django-admin` 中就存在这样的写法，可以利用其进行攻击。

## 0x02 漏洞分析

当我们进行查询时，会使用到 `QuerySet` ，一般形式为

```
Collection.objects.filter(blog__author__extra='tom').all()
```

`filter` 中包含三个部分，由 `__` 分割，第一部分被称为 `transform` ，比如此处，就是查找 `blog` 表中的 `author` 字段，一般这里就是通过外键表现两个表之间的关系，但也存在特殊情况，比如存在 `JSONField` 类型的字段时，那么就是从 `JSON` 字段中查找；第二部分是字段，表的字段或者 `JSON` 的字段；第三部分被称为 `lookup` ，表示为后面值之间的对比关系，可不写，默认为 `extra`。

此处我们选择 `JSONField` 进行分析，当 `blog` 字段为 `JSONField` 类型时，

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220921171923.png)

`JSONField` 继承自 `Field` ，`Field` 又是继承 `RegisterLookupMixin` ，已经存在一个 `get_transform` 方法，此处由于获取方式不同，因此重写该方法，之后是返回了一个 `KeyTransformFactory(name)` ，接下来看看这里的代码

![](https://gitee.com/d5shenwu/picgo/raw/master/img/image-20220921173225909.png)

直接被调用时，又会触发 `KeyTransform(self.key_name, *args, **kwargs)`

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220921173335.png)

在这里，最后会被执行 `as_sql` 方法，目的是生成 `sql` 语句，但是这里的 `self.key_name` 没有经过任何过滤就被拼接并直接返回，因此造成了注入。

## 0x03 漏洞复现

复现直接借助了 `vulhub` 的环境，直接启动，环境代码可以直接在最下面的参考链接中找到

如下所示，`Collections` 就是在 `model` 中使用了 `JSONField` 

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220921153333.png)

代码和细节如下

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220921153819.png)

此处的 `detail` 使用了 `JSONField` ，访问链接即可触发漏洞

```
http://your-ip:8000/admin/vuln/collection/?detail__a%27b=123
```

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220921154135.png)

## 0x04 总结

这里也就是只需要能控制键名即可进行注入，有一点需要注意的是，需要是 `postgres` 数据库才可以这样做，因为这里只有 `postgres` 数据库是支持 `JSONField` 的用法。

## 0x05 链接

目前在学代码审计，对此感兴趣的师傅可以加好友一起交流学习

环境与 `exp` 都可以在如下链接获取

### 参考链接

https://github.com/vulhub/vulhub/blob/master/django/CVE-2019-14234/README.zh-cn.md

### GitHub

https://github.com/d5shenwu/vulPOC



