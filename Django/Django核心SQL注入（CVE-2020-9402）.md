# Django核心SQL注入（CVE-2020-9402）

本文仅用于技术讨论与研究，文中的实现方法切勿应用在任何违法场景。如因涉嫌违法造成的一切不良影响，本文作者概不负责。

## 0x00 漏洞描述

`Django` 在2020年发布的安全更新，修复了在 `GIS` 查询功能中存在的 `SQL` 注入漏洞。

## 0x01 漏洞影响

- Django 2.2.x < 2.2.11
- Django 1.11.x < 1.11.29
- Django 3.0.x < 3.0.4

需要使用了 `GIS` 聚合查询，用户使用 `oracle` 的数据库且存在可控 `tolerance` 

## 0x02 漏洞分析

首先看 `github` 的分析  `https://github.com/django/django/commit/fe886a3b58a93cfbe8864b485f93cb6d426cd1f2`

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220921205621.png)

这里修补了两处漏洞，都是同一个参数 `tolerance` 引起的，看到这里会觉得还比较简单，直接从 `self.extra` 中获取到参数，直接进行拼接，得到最后的 `sql` 代码，`as_oracle` 方法，就是得到的 `oracle` 的 `sql` 代码，也就是这个漏洞应该只存在于使用 `oracle` 数据库时

虽然知道这里存在漏洞，我们更重要的是去获取什么时候会触发这两个漏洞，所以要去看代码，可以直接搜索 `tolerance`

### 第一处漏洞

位于 `django\contrib\gis\db\models\aggregates.py`

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220921210237.png)

此类继承于 `django.db.models.aggregates.Aggregate` ，然后下面这个 `Union` 类又继承 `GeoAggregate` 

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220921210544.png)

因此可以通过使用 `GIS` 中的 `Union` 类来触发第一个漏洞

### 第二处漏洞

位于 `django\contrib\gis\db\models\functions.py`

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220921211016.png)

这里逻辑也是一样，没有任何过滤，接下来就是去找可以直接调用这里的位置，也就是找继承的位置，可以找到下面这个 `Distance`

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220921211202.png)

至于接下来该如何去直接使用这两个类，可以查看官方文档，这里我直接看的 `vulhub` 中的

![](https://gitee.com/d5shenwu/picgo/raw/master/img/20220921211336.png)



## 0x03 漏洞复现

复现直接借助了 `vulhub` 的环境，直接启动，环境代码可以直接在最下面的参考链接中找到

第一处 `payload`

```
http://127.0.0.1:8000/vuln/q=?20) = 1 OR (select utl_inaddr.get_host_name((SELECT version FROM v$instance)) from dual) is null OR (1-1
```

![](https://gitee.com/d5shenwu/picgo/raw/master/img/image-20220921212748553.png)

第二处 `payload`

```
http://127.0.0.1:8000/vuln2/q=?0.05))) FROM "VULN_COLLECTION2" where (select utl_inaddr.get_host_name((SELECT user FROM DUAL)) from dual) is not null --
```

![](https://gitee.com/d5shenwu/picgo/raw/master/img/image-20220921212404303.png)



## 0x04 总结

出现漏洞的地方不是很难找到，但是要找可以利用到的位置还是需要花费一定时间，说不定还有其他地方也存在这样的问题。

## 0x05 链接

目前在学代码审计，对此感兴趣的师傅可以加好友一起交流学习

环境与 `exp` 都可以在如下链接获取

### 参考链接

https://github.com/vulhub/vulhub/blob/master/django/CVE-2020-9402/README.zh-cn.md

### GitHub

https://github.com/d5shenwu/vulPOC



